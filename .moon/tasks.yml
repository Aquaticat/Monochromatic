$schema: 'https://moonrepo.dev/schemas/tasks.json'

# The following file groups are automatically added to ALL tasks as inputs.
# You don't need to explicitly add these to individual task inputs.
implicitInputs:
- '@group(configs)'
- '@group(sources)'

fileGroups:
  indexHtml:
  - 'index.html'
  configs:
  - '*.config.{cjs,mjs,ts}'
  - '*.{json,jsonc,yaml,yml,toml}'
  sources:
  - 'src/**/*.{ts,astro,html,vue,mjs,js,cjs,mdx,json,toml}'
  distJs:
  - 'dist/final/js/**/*'
  dist:
  - 'dist/**/*'
  allDistTypes:
  - '/packages/*/*/dist/final/types/**/*'
  allDistJs:
  - '/packages/*/*/dist/final/js/**/*'
  allSources:
  - '/packages/*/*/src/**/*.{ts,astro,html,vue,mjs,js,cjs,mdx,json,toml}'
  allDists:
  - '/packages/*/*/dist/**/*'
  allConfigs:
  # Changing anything in `.moon` auto triggers cache invalidation.
  # - '/.moon/**/*.{yml,pkl}'
  - '/**/*.config.{cjs,mjs,ts}'
  - '/**/*.{json,jsonc,yaml,yml,toml}'

taskOptions:
  inferInputs: false
  mergeArgs: replace
  mergeInputs: replace
  mergeOutputs: replace
  # Enable output as needed.
  outputStyle: buffer-only-failure
  # Timeout overriding behavior seems broken. Tried overriding it with both 0 and null.
  # `null` terminates the process in 30s still.
  # `0` terminates the process immediately.
  # Workaround: manually define override in individual tasks.
  # timeout: 30
  # Enable running task on command line as needed.
  internal: true

tasks:
  _shell:
    options:
      unixShell: 'bash'
      windowsShell: 'bash'
      shell: true

  # Template for lint/format tasks
  # Note: cache is disabled due to Moon's cache overhead with filesystem-intensive
  # operations and tasks with large numbers of inputs/outputs from expanded globs
  _lintFormatBase:
    options:
      cache: false
      unixShell: 'bash'
      windowsShell: 'bash'
      shell: true
      internal: false

  # My own server preset because Moon builtin server preset doesn't override timeout to none.
  _server:
    options:
      cache: false
      outputStyle: stream
      persistent: true
      runInCI: false
      internal: false
