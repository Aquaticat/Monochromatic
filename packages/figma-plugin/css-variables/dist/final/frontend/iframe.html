<!DOCTYPE html>
<html lang='en'>
  <head>
    <meta charset='UTF-8'>
    <meta
      name='viewport'
      content='width=device-width, initial-scale=1.0'>
    <title>iframe authored css</title>
    <style rel="stylesheet" crossorigin>#authoredCss{position:absolute;top:-7680px}.iframeContainer,html{overflow-block:clip;overflow-inline:clip;max-block-size:min(100%,100dvb);max-inline-size:min(100%,100dvi);position:relative;overflow:clip}</style>
  </head>
  <body>
    <script>
    const defaultElementWidthNumber = 3840 - 8 * 2;
      window.addEventListener('message', async (event) => {
        if (Object.hasOwn(event.data, 'css')) {
          console.log(`inner iframe received message: ${event.data.css}`);
          const sheet = await new CSSStyleSheet().replace(event.data.css);
          document.adoptedStyleSheets = [sheet];
          event.source.postMessage({ authoredCss: 'adopted stylesheets applied' },
            '*');

          const ruleList = sheet.cssRules;
          for (const rule of ruleList) {
            // Basic Rules
            if (rule.selectorText === ':root') {
              // console.log(rule.style);

              for (const ruleStyle of rule.style) {
                if (ruleStyle.startsWith('--')) {
                  const cssVar = ruleStyle;
                  const cssValue = rule.style.getPropertyValue(cssVar);
                  console.log(`css var: ${cssVar} value: ${cssValue}`);

                  // Find out the type of the css var
                  // Maybe this is not needed.
                  const cssVarType = (() => {
                    if (!isNaN(cssValue) && !isNaN(parseFloat(cssValue))) {
                      return 'number';
                    } else if (cssValue.startsWith('rgb')) {
                      return 'color';
                    } else if (cssValue.startsWith('url')) {
                      return 'url';
                    } else if (cssValue.startsWith('var')) {
                      return 'cssVar';
                    } else if (cssValue.startsWith('#')) {
                      return 'hexColor';
                    } else if (cssValue.startsWith('hsl')) {
                      return 'hslColor';
                    } else if (cssValue.startsWith('calc')) {
                      return 'calc';
                    } else if (cssValue.startsWith('linear-gradient')) {
                      return 'gradient';
                    } else {
                      return 'string';
                    }
                  })();

                  // create multiple test elements to test the css var
                  await Promise.all[
                    (async () => {
                      const testElementAssumeUnitfulLength = document.createElement(
                        'div',
                      );
                      testElementAssumeUnitfulLength.style.width = cssValue;
                      testElementAssumeUnitfulLength.style.height = cssValue;
                      document.body.appendChild(testElementAssumeUnitfulLength);

                      const computedStyle = window.getComputedStyle(
                        testElementAssumeUnitfulLength,
                      );
                      if (
                        computedStyle.getPropertyValue('width')
                          === `${defaultElementWidthNumber}px`
                      ) {
                        console.log(
                          `${cssVar} isn't a unitful length value. Try treating it as a number`,
                        );
                      }
                    })()
                  ];
                } else {
                  // console.log(`non-css var: ${ruleStyle}`);
                }
              }
            } else {
              console.log(`non-basic rule: ${rule.selectorText}`);
            }
          }
        }
      });
    </script>
  </body>
</html>
